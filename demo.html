
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHRS 水龙头认证系统演示</title>
    <!-- reCAPTCHA v2 -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <!-- ethers.js v5 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"
            onerror="loadBackupEthers()"></script>
    <script>
        // 备用 ethers.js 加载
        function loadBackupEthers() {
            console.log('主 CDN 失败，尝试备用 CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
            script.onerror = function() {
                console.error('所有 ethers.js CDN 都失败了');
                alert('ethers.js 加载失败，请检查网络连接或刷新页面重试');
            };
            document.head.appendChild(script);
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.2s;
        }
        button:hover {
            background: #357abd;
        }
        button:disabled {
            background: #d3d3d3;
            cursor: not-allowed;
            color: #999;
        }

        #claimCountdown {
            color: #ff6b6b;
            font-weight: bold;
            font-size: 0.9em;
        }

        #claimTokens {
            min-width: 200px;
            position: relative;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .token-display {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        .wallet-address {
            font-family: monospace;
            background: #e9ecef;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PHRS 水龙头认证系统演示</h1>
        
        <div class="section">
            <h3>1. 连接钱包</h3>
            <button id="connectWallet">连接 MetaMask</button>
            <div id="walletStatus"></div>
        </div>

        <div class="section">
            <h3>2. 获取签名消息</h3>
            <button id="getNonce" disabled>获取 Nonce</button>
            <div id="nonceStatus"></div>
        </div>

        <div class="section">
            <h3>3. 签名并登录</h3>
            <button id="signAndLogin" disabled>签名并登录</button>
            <div id="loginStatus"></div>
        </div>

        <div class="section">
            <h3>4. 用户信息</h3>
            <button id="getUserInfo" disabled>获取用户信息</button>
            <button id="clearLocalAuth" disabled>清除本地认证</button>
            <div id="userInfoStatus"></div>
        </div>

        <div class="section">
            <h3>5. 验证令牌</h3>
            <button id="verifyToken" disabled>验证当前令牌</button>
            <div id="verifyStatus"></div>
        </div>

        <div class="section">
            <h3>6. Twitter OAuth 集成</h3>
            <button id="checkTwitterStatus" disabled>检查 Twitter 连接状态</button>
            <button id="connectTwitter" disabled>连接 Twitter 账户</button>
            <button id="disconnectTwitter" disabled style="display:none;">断开 Twitter 连接</button>
            <div id="twitterStatus"></div>
        </div>

        <div class="section">
            <h3>7. 水龙头领取</h3>
            <div style="margin-bottom: 15px; padding: 10px; background-color: #f0f8ff; border-radius: 5px;">
                <strong>每日领取金额: 0.1 PHRS</strong><br>
                <small>每个钱包地址、IP地址、Twitter账户每24小时只能领取一次</small><br>
                <small><strong>网络:</strong> Pharos Testnet (Chain ID: 688688)</small>
            </div>
            <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border-radius: 5px;">
                <strong>网络状态:</strong> <span id="networkStatus">请先连接钱包</span><br>
                <button id="checkNetwork" style="margin-top: 5px; padding: 5px 10px; font-size: 12px;">检查网络</button>
            </div>

            <div id="faucet-recaptcha-container" style="margin-bottom: 15px;">
                <div class="g-recaptcha" data-sitekey="6LchwbIrAAAAAEkI8iLHCgWV13kSiQhj9Wov_1he" data-callback="onFaucetRecaptchaSuccess" data-expired-callback="onFaucetRecaptchaExpired"></div>
            </div>
            <button id="checkFaucetStatus" disabled>检查领取状态</button>
            <button id="claimTokens" disabled>
                <span id="claimButtonText">领取代币</span>
                <span id="claimCountdown" style="display: none;"></span>
            </button>
            <div id="faucetStatus"></div>
        </div>
    </div>

    <script>
        // 全局状态
        let walletAddress = null;
        let currentNonce = null;
        let currentMessage = null;
        let authToken = null;
        let faucetRecaptchaToken = null;
        let countdownTimer = null;
        let currentCooldownTime = 0; // 水龙头 reCAPTCHA token

        // 网络配置
        const NETWORK_CONFIG = {
            chainId: 688688,
            chainIdHex: '0xA8230', // 688688 的正确十六进制
            networkName: 'Pharos Testnet',
            rpcUrl: 'https://testnet.dplabs-internal.com',
            blockExplorerUrl: 'https://testnet.pharosscan.xyz',
            currencySymbol: 'PHRS',
            currencyDecimals: 18
        };

        // 合约配置
        const FAUCET_CONTRACT_ADDRESS = '0x14395C2E7beB6D32020E84f8849C06564c92ad40';
        const CHAIN_ID = NETWORK_CONFIG.chainId;

        // PHRSFaucet 合约 ABI (只包含需要的方法)
        const FAUCET_ABI = [
            {
                "inputs": [
                    {"internalType": "uint256", "name": "amount", "type": "uint256"},
                    {"internalType": "bytes32", "name": "nonce", "type": "bytes32"},
                    {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
                    {"internalType": "string", "name": "ip", "type": "string"},
                    {"internalType": "string", "name": "twitterId", "type": "string"},
                    {"internalType": "bytes", "name": "signature", "type": "bytes"}
                ],
                "name": "claimTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // reCAPTCHA 回调函数
        function onFaucetRecaptchaSuccess(token) {
            faucetRecaptchaToken = token;
            console.log('水龙头 reCAPTCHA 验证成功');

            // 检查是否可以启用领取按钮
            checkClaimButtonState();
        }

        function onFaucetRecaptchaExpired() {
            faucetRecaptchaToken = null;
            console.log('水龙头 reCAPTCHA 已过期，请重新验证');
            document.getElementById('claimTokens').disabled = true;
        }

        // 检查领取按钮状态
        function checkClaimButtonState() {
            const hasAuth = authToken;
            const hasRecaptcha = faucetRecaptchaToken;
            const noCooldown = currentCooldownTime <= 0;

            // 只有在没有冷却时间的情况下才根据其他条件启用按钮
            if (noCooldown) {
                document.getElementById('claimTokens').disabled = !(hasAuth && hasRecaptcha);
            } else {
                // 有冷却时间时保持禁用状态
                document.getElementById('claimTokens').disabled = true;
            }
        }

        // 检查并切换到正确的网络
        async function ensureCorrectNetwork() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('请安装 MetaMask 钱包');
                }

                // 获取当前网络
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                const currentChainIdDecimal = parseInt(currentChainId, 16);

                console.log('当前网络 Chain ID:', currentChainIdDecimal);
                console.log('目标网络 Chain ID:', NETWORK_CONFIG.chainId);

                if (currentChainIdDecimal === NETWORK_CONFIG.chainId) {
                    console.log('已在正确的网络');
                    return true;
                }

                console.log('网络不正确，尝试切换...');

                try {
                    // 尝试切换到目标网络
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: NETWORK_CONFIG.chainIdHex }],
                    });

                    console.log('网络切换成功');
                    return true;

                } catch (switchError) {
                    console.log('切换失败，错误代码:', switchError.code);

                    // 如果网络不存在 (错误代码 4902)，尝试添加网络
                    if (switchError.code === 4902) {
                        console.log('网络不存在，尝试添加...');

                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: NETWORK_CONFIG.chainIdHex,
                                    chainName: NETWORK_CONFIG.networkName,
                                    rpcUrls: [NETWORK_CONFIG.rpcUrl],
                                    blockExplorerUrls: [NETWORK_CONFIG.blockExplorerUrl],
                                    nativeCurrency: {
                                        name: NETWORK_CONFIG.currencySymbol,
                                        symbol: NETWORK_CONFIG.currencySymbol,
                                        decimals: NETWORK_CONFIG.currencyDecimals
                                    }
                                }]
                            });

                            console.log('网络添加成功');
                            return true;

                        } catch (addError) {
                            console.error('添加网络失败:', addError);
                            throw new Error('添加网络失败，请手动添加 Pharos Testnet 网络');
                        }
                    } else {
                        // 用户拒绝切换或其他错误
                        throw new Error('网络切换失败，请手动切换到 Pharos Testnet 网络');
                    }
                }

            } catch (error) {
                console.error('网络检查失败:', error);
                throw error;
            }
        }





        // 格式化倒计时显示
        function formatCountdown(seconds) {
            if (seconds <= 0) return '';

            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}小时${minutes}分钟`;
            } else if (minutes > 0) {
                return `${minutes}分${secs}秒`;
            } else {
                return `${secs}秒`;
            }
        }

        // 开始倒计时
        function startCountdown(remainingSeconds) {
            // 清除现有的倒计时
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }

            currentCooldownTime = remainingSeconds;

            if (remainingSeconds <= 0) {
                // 没有冷却时间，启用按钮
                enableClaimButton();
                return;
            }

            // 禁用按钮并显示倒计时
            disableClaimButton();
            updateCountdownDisplay();

            countdownTimer = setInterval(() => {
                currentCooldownTime--;

                if (currentCooldownTime <= 0) {
                    clearInterval(countdownTimer);
                    enableClaimButton();
                } else {
                    updateCountdownDisplay();
                }
            }, 1000);
        }

        // 更新倒计时显示
        function updateCountdownDisplay() {
            const countdownElement = document.getElementById('claimCountdown');
            const buttonTextElement = document.getElementById('claimButtonText');

            if (currentCooldownTime > 0) {
                buttonTextElement.style.display = 'none';
                countdownElement.style.display = 'inline';
                countdownElement.textContent = `冷却中 (${formatCountdown(currentCooldownTime)})`;
            } else {
                buttonTextElement.style.display = 'inline';
                countdownElement.style.display = 'none';
            }
        }

        // 启用领取按钮
        function enableClaimButton() {
            const button = document.getElementById('claimTokens');
            const buttonTextElement = document.getElementById('claimButtonText');
            const countdownElement = document.getElementById('claimCountdown');

            button.disabled = false;
            buttonTextElement.style.display = 'inline';
            buttonTextElement.textContent = '领取代币';
            countdownElement.style.display = 'none';

            // 检查其他条件（reCAPTCHA等）
            checkClaimButtonState();
        }

        // 禁用领取按钮
        function disableClaimButton() {
            const button = document.getElementById('claimTokens');
            button.disabled = true;
        }

        // 检查网络状态并更新显示
        async function checkNetworkStatus() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    document.getElementById('networkStatus').innerHTML = '未安装 MetaMask';
                    return;
                }

                // 检查是否有连接的账户，如果没有则不检查网络
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length === 0) {
                        document.getElementById('networkStatus').innerHTML = '请先连接钱包';
                        return;
                    }
                } catch (accountError) {
                    document.getElementById('networkStatus').innerHTML = '请先连接钱包';
                    return;
                }

                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                const currentChainIdDecimal = parseInt(currentChainId, 16);

                if (currentChainIdDecimal === NETWORK_CONFIG.chainId) {
                    document.getElementById('networkStatus').innerHTML = 'Pharos Testnet';
                } else {
                    // 尝试获取网络名称
                    let networkName = `未知网络 (${currentChainIdDecimal})`;

                    // 常见网络名称映射
                    const networkNames = {
                        1: 'Ethereum Mainnet',
                        5: 'Goerli Testnet',
                        11155111: 'Sepolia Testnet',
                        137: 'Polygon Mainnet',
                        80001: 'Polygon Mumbai',
                        56: 'BSC Mainnet',
                        97: 'BSC Testnet',
                        1001: 'Klaytn Testnet'
                    };

                    if (networkNames[currentChainIdDecimal]) {
                        networkName = networkNames[currentChainIdDecimal];
                    }

                    document.getElementById('networkStatus').innerHTML = `${networkName}`;
                }
            } catch (error) {
                console.error('检查网络状态失败:', error);
                document.getElementById('networkStatus').innerHTML = '检查失败';
            }
        }

        // 检查 ethers.js 是否加载
        function checkEthersLoaded() {
            return new Promise((resolve, reject) => {
                if (typeof ethers !== 'undefined') {
                    resolve(true);
                    return;
                }

                // 等待 ethers.js 加载
                let attempts = 0;
                const maxAttempts = 50; // 5秒超时

                const checkInterval = setInterval(() => {
                    attempts++;

                    if (typeof ethers !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('ethers.js 加载超时，请刷新页面重试'));
                    }
                }, 100);
            });
        }

        // API 基础 URL
        const API_BASE = '/api/faucet-auth';

        // 工具函数
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function formatAddress(address) {
            return `<span class="wallet-address">${address.slice(0, 6)}...${address.slice(-4)}</span>`;
        }

        // 1. 连接钱包
        document.getElementById('connectWallet').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('walletStatus', '请安装 MetaMask!', 'error');
                    return;
                }

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                walletAddress = accounts[0];
                showStatus('walletStatus', `钱包已连接: ${formatAddress(walletAddress)}`, 'success');

                // 启用下一步按钮
                document.getElementById('getNonce').disabled = false;

                // 连接成功后检查网络状态
                checkNetworkStatus();

            } catch (error) {
                showStatus('walletStatus', `连接失败: ${error.message}`, 'error');
            }
        });

        // 2. 获取 nonce
        document.getElementById('getNonce').addEventListener('click', async () => {
            try {
                showStatus('nonceStatus', '正在获取 nonce...', 'info');

                const response = await fetch(`${API_BASE}/nonce`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ walletAddress })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                currentNonce = data.data.nonce;
                currentMessage = data.data.message;

                showStatus('nonceStatus', `Nonce 获取成功: ${currentNonce}<br><br><strong>签名消息:</strong><div class="token-display">${currentMessage}</div>`, 'success');
                
                // 启用下一步按钮
                document.getElementById('signAndLogin').disabled = false;

            } catch (error) {
                showStatus('nonceStatus', `获取 nonce 失败: ${error.message}`, 'error');
            }
        });

        // 3. 签名并登录
        document.getElementById('signAndLogin').addEventListener('click', async () => {
            try {
                showStatus('loginStatus', '正在请求签名...', 'info');

                // 请求用户签名
                const signature = await window.ethereum.request({
                    method: 'personal_sign',
                    params: [currentMessage, walletAddress]
                });

                showStatus('loginStatus', '签名成功，正在登录...', 'info');

                // 发送登录请求
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        walletAddress,
                        signature,
                        message: currentMessage
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                authToken = data.data.token;
                const user = data.data.user;
                const isNewUser = data.data.isNewUser;

                // 保存 JWT Token 到本地存储
                localStorage.setItem('faucetAuthToken', authToken);
                localStorage.setItem('faucetUser', JSON.stringify(user));
                console.log('✅ JWT Token 已保存到本地存储');

                showStatus('loginStatus',
                    `${isNewUser ? '注册并登录' : '登录'}成功!<br><br>` +
                    `<div class="user-info">` +
                    `<strong>用户信息:</strong><br>` +
                    `ID: ${user.id}<br>` +
                    `钱包: ${formatAddress(user.walletAddress)}<br>` +
                    `用户名: ${user.username}<br>` +
                    `状态: ${user.isActive ? '活跃' : '非活跃'}<br>` +
                    `创建时间: ${new Date(user.createdAt).toLocaleString()}` +
                    `</div>` +
                    `<strong>JWT Token:</strong><div class="token-display">${authToken}</div>`,
                    'success'
                );

                // 启用后续按钮
                document.getElementById('getUserInfo').disabled = false;
                document.getElementById('verifyToken').disabled = false;
                document.getElementById('checkTwitterStatus').disabled = false;
                document.getElementById('connectTwitter').disabled = false;
                document.getElementById('clearLocalAuth').disabled = false;
                document.getElementById('checkFaucetStatus').disabled = false;
                checkClaimButtonState();

            } catch (error) {
                showStatus('loginStatus', `登录失败: ${error.message}`, 'error');
            }
        });

        // 4. 获取用户信息
        document.getElementById('getUserInfo').addEventListener('click', async () => {
            try {
                showStatus('userInfoStatus', '正在获取用户信息...', 'info');

                const response = await fetch(`${API_BASE}/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                const user = data.data.user;

                showStatus('userInfoStatus',
                    `用户信息获取成功!<br><br>` +
                    `<div class="user-info">` +
                    `<strong>详细信息:</strong><br>` +
                    `ID: ${user.id}<br>` +
                    `钱包: ${formatAddress(user.walletAddress)}<br>` +
                    `用户名: ${user.username}<br>` +
                    `状态: ${user.isActive ? '活跃' : '非活跃'}<br>` +
                    `最后登录: ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString() : '从未'}<br>` +
                    `创建时间: ${new Date(user.createdAt).toLocaleString()}<br>` +
                    `更新时间: ${new Date(user.updatedAt).toLocaleString()}` +
                    `</div>`,
                    'success'
                );

            } catch (error) {
                showStatus('userInfoStatus', `获取用户信息失败: ${error.message}`, 'error');
            }
        });

        // 4.1 清除本地认证
        document.getElementById('clearLocalAuth').addEventListener('click', async () => {
            try {
                // 清除本地存储
                clearLocalAuth();

                // 重置页面状态
                document.getElementById('getUserInfo').disabled = true;
                document.getElementById('verifyToken').disabled = true;
                document.getElementById('checkTwitterStatus').disabled = true;
                document.getElementById('connectTwitter').disabled = true;
                document.getElementById('disconnectTwitter').disabled = true;
                document.getElementById('clearLocalAuth').disabled = true;

                // 清除状态显示
                showStatus('loginStatus', '本地认证已清除，请重新登录', 'info');
                showStatus('userInfoStatus', '', 'info');
                showStatus('verifyStatus', '', 'info');
                showStatus('twitterStatus', '', 'info');

                console.log('本地认证状态已清除');

            } catch (error) {
                console.error('清除本地认证失败:', error);
            }
        });

        // 5. 验证令牌
        document.getElementById('verifyToken').addEventListener('click', async () => {
            try {
                showStatus('verifyStatus', '正在验证令牌...', 'info');

                const response = await fetch(`${API_BASE}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ token: authToken })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                const user = data.data.user;

                showStatus('verifyStatus',
                    `令牌验证成功!<br><br>` +
                    `<div class="user-info">` +
                    `<strong>令牌有效，用户信息:</strong><br>` +
                    `ID: ${user.id}<br>` +
                    `钱包: ${formatAddress(user.walletAddress)}<br>` +
                    `用户名: ${user.username}<br>` +
                    `状态: ${user.isActive ? '活跃' : '非活跃'}` +
                    `</div>`,
                    'success'
                );

            } catch (error) {
                showStatus('verifyStatus', `令牌验证失败: ${error.message}`, 'error');
            }
        });

        // 6. 检查 Twitter 连接状态
        document.getElementById('checkTwitterStatus').addEventListener('click', async () => {
            try {
                showStatus('twitterStatus', '正在检查 Twitter 连接状态...', 'info');

                const response = await fetch(`${API_BASE}/twitter/status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                const { connected, faucetUser, twitter } = data.data;

                if (connected && twitter) {
                    showStatus('twitterStatus',
                        `Twitter 已连接!<br><br>` +
                        `<div class="user-info">` +
                        `<strong>Twitter 信息:</strong><br>` +
                        `用户名: @${twitter.username}<br>` +
                        `显示名: ${twitter.name}<br>` +
                        `验证状态: ${twitter.verified ? '已验证' : '未验证'}<br>` +
                        `关注者: ${twitter.publicMetrics?.followers_count || 0}<br>` +
                        `连接时间: ${new Date(twitter.connectedAt).toLocaleString()}` +
                        `</div>`,
                        'success'
                    );

                    document.getElementById('connectTwitter').style.display = 'none';
                    document.getElementById('disconnectTwitter').style.display = 'inline-block';
                    document.getElementById('disconnectTwitter').disabled = false;
                } else {
                    showStatus('twitterStatus',
                        `Twitter 未连接<br><br>` +
                        `<div class="user-info">` +
                        `<strong>水龙头用户:</strong><br>` +
                        `钱包: ${formatAddress(faucetUser.walletAddress)}<br>` +
                        `用户名: ${faucetUser.username}` +
                        `</div>`,
                        'info'
                    );

                    document.getElementById('connectTwitter').style.display = 'inline-block';
                    document.getElementById('disconnectTwitter').style.display = 'none';
                }

            } catch (error) {
                showStatus('twitterStatus', `检查 Twitter 状态失败: ${error.message}`, 'error');
            }
        });

        // 7. 连接 Twitter 账户
        document.getElementById('connectTwitter').addEventListener('click', async () => {
            try {
                showStatus('twitterStatus', '正在启动 Twitter 授权...', 'info');

                // 直接跳转到 Twitter 授权页面
                window.location.href = `${API_BASE}/twitter`;

            } catch (error) {
                showStatus('twitterStatus', `启动 Twitter 授权失败: ${error.message}`, 'error');
            }
        });

        // 8. 断开 Twitter 连接
        document.getElementById('disconnectTwitter').addEventListener('click', async () => {
            try {
                showStatus('twitterStatus', '正在断开 Twitter 连接...', 'info');

                const response = await fetch(`${API_BASE}/twitter/disconnect`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                showStatus('twitterStatus',
                    `Twitter 连接已断开!<br><br>` +
                    `<div class="user-info">` +
                    `<strong>水龙头用户:</strong><br>` +
                    `钱包: ${formatAddress(data.data.faucetUser.walletAddress)}<br>` +
                    `用户名: ${data.data.faucetUser.username}` +
                    `</div>`,
                    'success'
                );

                document.getElementById('connectTwitter').style.display = 'inline-block';
                document.getElementById('disconnectTwitter').style.display = 'none';

            } catch (error) {
                showStatus('twitterStatus', `断开 Twitter 连接失败: ${error.message}`, 'error');
            }
        });

        // 9. 检查水龙头状态
        document.getElementById('checkFaucetStatus').addEventListener('click', async () => {
            try {
                showStatus('faucetStatus', '正在检查水龙头状态...', 'info');

                const token = localStorage.getItem('faucetAuthToken') || authToken;
                if (!token) {
                    throw new Error('请先登录');
                }

                const response = await fetch(`${API_BASE}/claim/status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                const { canClaim, user, ip, twitter, rateLimit } = data.data;

                let statusHtml = `<div class="user-info">`;
                statusHtml += `<strong>领取状态:</strong> ${canClaim ? '可以领取' : '暂时无法领取'}<br><br>`;

                statusHtml += `<strong>用户状态:</strong><br>`;
                statusHtml += `地址: ${user.address.slice(0,6)}...${user.address.slice(-4)}<br>`;
                statusHtml += `可领取: ${user.canClaim ? '是' : '否'}<br>`;
                if (user.remainingTime) {
                    statusHtml += `冷却剩余: ${Math.floor(user.remainingTime / 3600)}小时${Math.floor((user.remainingTime % 3600) / 60)}分钟<br>`;
                }

                statusHtml += `<br><strong>IP 状态:</strong><br>`;
                statusHtml += `地址: ${ip.address}<br>`;
                statusHtml += `可领取: ${ip.canClaim ? '是' : '否'}<br>`;
                if (ip.remainingTime) {
                    statusHtml += `冷却剩余: ${Math.floor(ip.remainingTime / 3600)}小时${Math.floor((ip.remainingTime % 3600) / 60)}分钟<br>`;
                }

                statusHtml += `<br><strong>Twitter 状态:</strong><br>`;
                statusHtml += `绑定状态: ${twitter.isBound ? '已绑定' : '未绑定'}<br>`;
                if (twitter.username) {
                    statusHtml += `用户名: @${twitter.username}<br>`;
                }
                if (twitter.isBound) {
                    statusHtml += `可领取: ${twitter.canClaim ? '是' : '否'}<br>`;
                    if (twitter.remainingTime) {
                        statusHtml += `冷却剩余: ${Math.floor(twitter.remainingTime / 3600)}小时${Math.floor((twitter.remainingTime % 3600) / 60)}分钟<br>`;
                    }
                }

                statusHtml += `<br><strong>速率限制:</strong><br>`;
                statusHtml += `允许请求: ${rateLimit.allowed ? '是' : '否'}<br>`;
                statusHtml += `剩余次数: ${rateLimit.remaining}<br>`;
                statusHtml += `</div>`;

                showStatus('faucetStatus', statusHtml, canClaim ? 'success' : 'error');

                // 计算最长的冷却时间
                let maxCooldownTime = 0;
                if (user.remainingTime && user.remainingTime > 0) {
                    maxCooldownTime = Math.max(maxCooldownTime, user.remainingTime);
                }
                if (ip.remainingTime && ip.remainingTime > 0) {
                    maxCooldownTime = Math.max(maxCooldownTime, ip.remainingTime);
                }
                if (twitter.remainingTime && twitter.remainingTime > 0) {
                    maxCooldownTime = Math.max(maxCooldownTime, twitter.remainingTime);
                }

                // 启动倒计时
                startCountdown(maxCooldownTime);

                // 启用相关按钮
                document.getElementById('checkFaucetStatus').disabled = false;

            } catch (error) {
                showStatus('faucetStatus', `检查水龙头状态失败: ${error.message}`, 'error');
            }
        });

        // 10. 领取代币
        document.getElementById('claimTokens').addEventListener('click', async () => {
            try {
                // 检查 reCAPTCHA
                if (!faucetRecaptchaToken) {
                    showStatus('faucetStatus', '请先完成 reCAPTCHA 验证', 'error');
                    return;
                }

                // 检查钱包连接
                if (typeof window.ethereum === 'undefined') {
                    showStatus('faucetStatus', '请安装 MetaMask 钱包', 'error');
                    return;
                }

                showStatus('faucetStatus', '正在获取签名...', 'info');

                const token = localStorage.getItem('faucetAuthToken') || authToken;
                if (!token) {
                    throw new Error('请先登录');
                }

                const response = await fetch(`${API_BASE}/claim/signature`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        recaptchaToken: faucetRecaptchaToken
                    })
                });

                const data = await response.json();

                // 添加详细的调试信息
                console.log('获取签名响应:', data);

                if (!data.success) {
                    // 创建详细的错误信息
                    let errorDetails = {
                        message: data.message || data.error,
                        fullResponse: data
                    };

                    const error = new Error(data.message || data.error);
                    error.details = errorDetails;
                    throw error;
                }

                const { signature, params, domain, twitter, rateLimit } = data.data;

                const { usage } = data.data;

                showStatus('faucetStatus',
                    `签名获取成功，正在调用合约...<br><br>` +
                    `<div class="user-info">` +
                    `<strong>领取信息:</strong><br>` +
                    `金额: ${parseFloat(params.amount) / 1e18} PHRS<br>` +
                    `Twitter: @${twitter.username}<br>` +
                    `剩余请求: ${rateLimit.remaining}<br>` +
                    `</div>`,
                    'info'
                );

                // 直接调用合约
                await callFaucetContract(signature, params);

                // 重置 reCAPTCHA
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset();
                    faucetRecaptchaToken = null;
                    checkClaimButtonState();
                }

            } catch (error) {
                console.error('获取签名完整错误信息:', error);

                // 如果是IP冷却期错误，尝试获取当前IP信息
                let errorMessage = `获取签名失败: ${error.message}`;

                if (error.message.includes('IP address can claim again')) {
                    // 尝试获取当前IP地址信息
                    fetch('https://api.ipify.org?format=json')
                        .then(response => response.json())
                        .then(data => {
                            const currentIP = data.ip;

                            // 构建详细的错误信息
                            let debugInfo = '';
                            if (error.details && error.details.fullResponse) {
                                debugInfo = `<br><br><strong>调试信息:</strong><br>` +
                                           `<div class="token-display" style="font-size: 11px; max-height: 200px; overflow-y: auto;">` +
                                           `${JSON.stringify(error.details.fullResponse, null, 2)}` +
                                           `</div>`;
                            }

                            showStatus('faucetStatus',
                                `获取签名失败: ${error.message}<br><br>` +
                                `<div class="user-info">` +
                                `<strong>当前IP地址:</strong> ${currentIP}<br>` +
                                `<strong>状态:</strong> 冷却期中，请等待冷却时间结束<br>` +
                                `<strong>建议:</strong> 如果这是新IP，请联系管理员检查服务器配置` +
                                `</div>` +
                                debugInfo,
                                'error'
                            );
                        })
                        .catch(ipError => {
                            showStatus('faucetStatus', errorMessage, 'error');
                        });
                } else {
                    // 对于其他错误，也显示调试信息
                    let debugInfo = '';
                    if (error.details && error.details.fullResponse) {
                        debugInfo = `<br><br><strong>调试信息:</strong><br>` +
                                   `<div class="token-display" style="font-size: 11px; max-height: 200px; overflow-y: auto;">` +
                                   `${JSON.stringify(error.details.fullResponse, null, 2)}` +
                                   `</div>`;
                    }

                    showStatus('faucetStatus', errorMessage + debugInfo, 'error');
                }

                // 重置 reCAPTCHA
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset();
                    faucetRecaptchaToken = null;
                    checkClaimButtonState();
                }
            }
        });

        // 金额已固定为 0.1 PHRS，无需监听输入变化







        // 12. 检查网络按钮
        document.getElementById('checkNetwork').addEventListener('click', async () => {
            try {
                document.getElementById('networkStatus').innerHTML = '检查中...';

                if (typeof window.ethereum === 'undefined') {
                    document.getElementById('networkStatus').innerHTML = '请安装 MetaMask';
                    return;
                }

                await checkNetworkStatus();

                // 如果网络不正确，提示用户
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                const currentChainIdDecimal = parseInt(currentChainId, 16);

                if (currentChainIdDecimal !== NETWORK_CONFIG.chainId) {
                    const shouldSwitch = confirm(
                        `当前网络不正确。\n\n` +
                        `当前: ${currentChainIdDecimal}\n` +
                        `需要: ${NETWORK_CONFIG.chainId} (Pharos Testnet)\n\n` +
                        `是否自动切换到 Pharos Testnet？`
                    );

                    if (shouldSwitch) {
                        try {
                            document.getElementById('networkStatus').innerHTML = '切换中...';
                            await ensureCorrectNetwork();
                            await checkNetworkStatus();
                            alert('网络切换成功！');
                        } catch (error) {
                            alert(`网络切换失败: ${error.message}`);
                            await checkNetworkStatus();
                        }
                    }
                }

            } catch (error) {
                console.error('网络检查失败:', error);
                document.getElementById('networkStatus').innerHTML = '检查失败';
            }
        });

        // 处理 Twitter OAuth 回调
        async function handleTwitterCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const state = urlParams.get('state');
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const message = urlParams.get('message');

            if (error) {
                showStatus('twitterStatus', `Twitter 授权失败: ${decodeURIComponent(message || error)}`, 'error');
                // 清除 URL 参数
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (state && code) {
                showStatus('twitterStatus', '正在绑定 Twitter 账户...', 'info');

                try {
                    // 确保从本地存储获取最新的 token
                    const currentToken = localStorage.getItem('faucetAuthToken') || authToken;

                    if (!currentToken) {
                        throw new Error('未找到认证 Token，请先登录');
                    }

                    console.log('使用 JWT Token 进行 Twitter 绑定:', currentToken.substring(0, 20) + '...');

                    const response = await fetch(`${API_BASE}/twitter/bind`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentToken}`
                        },
                        credentials: 'include',
                        body: JSON.stringify({ state, code })
                    });

                    const data = await response.json();

                    if (data.success) {
                        const twitter = data.data.twitter;
                        showStatus('twitterStatus',
                            `Twitter 账户绑定成功!<br><br>` +
                            `<div class="user-info">` +
                            `<strong>Twitter 信息:</strong><br>` +
                            `用户名: @${twitter.username}<br>` +
                            `显示名: ${twitter.name}<br>` +
                            `验证状态: ${twitter.verified ? '已验证' : '未验证'}<br>` +
                            `关注者: ${twitter.publicMetrics?.followers_count || 0}<br>` +
                            `绑定时间: ${new Date(twitter.connectedAt).toLocaleString()}` +
                            `</div>`,
                            'success'
                        );

                        document.getElementById('connectTwitter').style.display = 'none';
                        document.getElementById('disconnectTwitter').style.display = 'inline-block';
                        document.getElementById('disconnectTwitter').disabled = false;
                    } else {
                        throw new Error(data.message || data.error);
                    }

                } catch (error) {
                    showStatus('twitterStatus', `Twitter 账户绑定失败: ${error.message}`, 'error');
                }

                // 清除 URL 参数
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // 检查本地存储的认证状态
        function checkLocalAuth() {
            const savedToken = localStorage.getItem('faucetAuthToken');
            const savedUser = localStorage.getItem('faucetUser');

            if (savedToken && savedUser) {
                try {
                    authToken = savedToken;
                    const user = JSON.parse(savedUser);

                    showStatus('loginStatus',
                        `从本地存储恢复登录状态<br><br>` +
                        `<div class="user-info">` +
                        `<strong>用户信息:</strong><br>` +
                        `ID: ${user.id}<br>` +
                        `钱包: ${formatAddress(user.walletAddress)}<br>` +
                        `用户名: ${user.username}<br>` +
                        `状态: ${user.isActive ? '活跃' : '非活跃'}` +
                        `</div>` +
                        `<strong>JWT Token:</strong><div class="token-display">${authToken}</div>`,
                        'success'
                    );

                    // 启用相关按钮
                    document.getElementById('getUserInfo').disabled = false;
                    document.getElementById('verifyToken').disabled = false;
                    document.getElementById('checkTwitterStatus').disabled = false;
                    document.getElementById('connectTwitter').disabled = false;
                    document.getElementById('clearLocalAuth').disabled = false;
                    document.getElementById('checkFaucetStatus').disabled = false;

                    console.log('从本地存储恢复了认证状态');

                    // 自动检查水龙头状态以获取倒计时信息
                    setTimeout(async () => {
                        try {
                            const response = await fetch(`${API_BASE}/claim/status`, {
                                headers: {
                                    'Authorization': `Bearer ${authToken}`
                                },
                                credentials: 'include'
                            });

                            const data = await response.json();
                            if (data.success) {
                                const { user, ip, twitter } = data.data;

                                // 计算最长的冷却时间
                                let maxCooldownTime = 0;
                                if (user.remainingTime && user.remainingTime > 0) {
                                    maxCooldownTime = Math.max(maxCooldownTime, user.remainingTime);
                                }
                                if (ip.remainingTime && ip.remainingTime > 0) {
                                    maxCooldownTime = Math.max(maxCooldownTime, ip.remainingTime);
                                }
                                if (twitter.remainingTime && twitter.remainingTime > 0) {
                                    maxCooldownTime = Math.max(maxCooldownTime, twitter.remainingTime);
                                }

                                // 启动倒计时
                                startCountdown(maxCooldownTime);

                                console.log('自动检查水龙头状态完成，冷却时间:', maxCooldownTime);
                            }
                        } catch (error) {
                            console.log('自动检查水龙头状态失败:', error.message);
                        }
                    }, 1000); // 延迟1秒执行，确保页面完全加载
                } catch (error) {
                    console.error('解析本地存储的用户信息失败:', error);
                    // 清除无效的本地存储
                    localStorage.removeItem('faucetAuthToken');
                    localStorage.removeItem('faucetUser');
                }
            }
        }

        // 清除本地认证状态
        function clearLocalAuth() {
            localStorage.removeItem('faucetAuthToken');
            localStorage.removeItem('faucetUser');
            authToken = null;
            console.log('已清除本地认证状态');
        }

        // 页面加载时检查 MetaMask 和 URL 参数
        window.addEventListener('load', async () => {
            if (typeof window.ethereum === 'undefined') {
                showStatus('walletStatus', '请安装 MetaMask 钱包扩展', 'error');
            } else {
                showStatus('walletStatus', 'MetaMask 已检测到，点击连接钱包', 'info');
            }

            // 检查 ethers.js 是否加载
            try {
                await checkEthersLoaded();
                console.log('ethers.js 加载成功');
            } catch (error) {
                console.error('ethers.js 加载失败:', error.message);
                showStatus('faucetStatus', '依赖库加载失败，请刷新页面', 'error');
            }

            // 检查本地存储的认证状态（不会自动连接钱包）
            checkLocalAuth();

            // 处理 Twitter OAuth 回调
            handleTwitterCallback();



            // 检查网络状态（仅在已连接钱包时）
            if (walletAddress) {
                checkNetworkStatus();
            }
        });

        // 监听网络变化
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('chainChanged', (chainId) => {
                console.log('网络已切换:', parseInt(chainId, 16));
                checkNetworkStatus();
            });
        }

        // 调用水龙头合约
        async function callFaucetContract(signature, params) {
            try {
                // 检查 ethers.js 是否加载
                showStatus('faucetStatus', '检查依赖库...', 'info');
                await checkEthersLoaded();

                // 检查并确保正确的网络
                showStatus('faucetStatus', '检查网络...', 'info');
                await ensureCorrectNetwork();

                // 获取用户账户
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    throw new Error('请先连接钱包');
                }

                const userAccount = accounts[0];
                if (userAccount.toLowerCase() !== params.user.toLowerCase()) {
                    throw new Error('当前钱包地址与签名地址不匹配');
                }

                showStatus('faucetStatus', '正在调用合约...', 'info');

                // 创建合约实例
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const contract = new ethers.Contract(FAUCET_CONTRACT_ADDRESS, FAUCET_ABI, signer);

                // 调用合约
                const tx = await contract.claimTokens(
                    params.amount,
                    params.nonce,
                    params.timestamp,
                    params.ip,
                    params.twitterId,
                    signature
                );

                showStatus('faucetStatus',
                    `交易已提交，等待确认...<br><br>` +
                    `<div class="user-info">` +
                    `交易哈希: <div class="token-display">${tx.hash}</div>` +
                    `</div>`,
                    'info'
                );

                // 等待交易确认
                const receipt = await tx.wait();

                // 通知后端合约执行成功
                showStatus('faucetStatus', '通知服务器合约执行成功...', 'info');

                try {
                    const confirmResponse = await fetch(`${API_BASE}/claim/confirm`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            nonce: params.nonce,
                            txHash: receipt.transactionHash,
                            success: true
                        })
                    });

                    const confirmData = await confirmResponse.json();

                    if (confirmData.success) {
                        console.log('服务器确认成功:', confirmData);

                        showStatus('faucetStatus',
                            `代币领取成功！<br><br>` +
                            `<div class="user-info">` +
                            `<strong>交易信息:</strong><br>` +
                            `交易哈希: <div class="token-display">${receipt.transactionHash}</div><br>` +
                            `区块号: ${receipt.blockNumber}<br>` +
                            `Gas 使用: ${receipt.gasUsed.toString()}<br>` +
                            `领取金额: 0.1 PHRS<br><br>` +
                            `<strong>领取成功！</strong><br>` +
                            `<strong>24小时冷却期已开始</strong>` +
                            `</div>`,
                            'success'
                        );

                        // 自动开始倒计时（24小时 = 86400秒，按后端冷却期计算）
                        startCountdown(86400);

                    } else {
                        console.warn('服务器确认失败:', confirmData);
                        showStatus('faucetStatus',
                            `代币领取成功，但服务器确认失败<br><br>` +
                            `<div class="user-info">` +
                            `交易哈希: <div class="token-display">${receipt.transactionHash}</div><br>` +
                            `错误: ${confirmData.error || confirmData.message}<br><br>` +
                            `<strong>注意:</strong> 代币已成功领取，但冷却期可能未正确设置` +
                            `</div>`,
                            'warning'
                        );
                    }
                } catch (confirmError) {
                    console.error('确认接口调用失败:', confirmError);
                    showStatus('faucetStatus',
                        `代币领取成功，但服务器通知失败<br><br>` +
                        `<div class="user-info">` +
                        `交易哈希: <div class="token-display">${receipt.transactionHash}</div><br>` +
                        `确认错误: ${confirmError.message}<br><br>` +
                        `<strong>注意:</strong> 代币已成功领取，但冷却期可能未正确设置` +
                        `</div>`,
                        'warning'
                    );
                }

                // 重置 reCAPTCHA
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset();
                    faucetRecaptchaToken = null;
                    checkClaimButtonState();
                }

            } catch (error) {
                console.error('合约调用失败:', error);

                let errorMessage = error.message;
                let shouldNotifyServer = false;
                let txHash = null;

                // 处理常见错误
                if (error.code === 4001) {
                    errorMessage = '用户取消了交易';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = '账户余额不足支付 Gas 费用';
                } else if (error.message.includes('CooldownNotMet')) {
                    errorMessage = '冷却期未满，请24小时后再试';
                } else if (error.message.includes('InvalidSignature')) {
                    errorMessage = '签名验证失败';
                } else if (error.message.includes('NonceAlreadyUsed')) {
                    errorMessage = '签名已被使用';
                }

                // 如果交易已经提交但失败了，需要通知服务器
                if (error.transaction && error.transaction.hash) {
                    shouldNotifyServer = true;
                    txHash = error.transaction.hash;
                    errorMessage += `<br>交易哈希: ${txHash}`;
                }

                showStatus('faucetStatus', `合约调用失败: ${errorMessage}`, 'error');

                // 如果有交易哈希，通知服务器交易失败
                if (shouldNotifyServer && txHash) {
                    try {
                        const confirmResponse = await fetch(`${API_BASE}/claim/confirm`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                nonce: params.nonce,
                                txHash: txHash,
                                success: false
                            })
                        });

                        const confirmData = await confirmResponse.json();
                        console.log('服务器已确认交易失败:', confirmData);
                    } catch (confirmError) {
                        console.error('通知服务器交易失败时出错:', confirmError);
                    }
                }

                throw error;
            }
        }


    </script>
</body>
</html>
